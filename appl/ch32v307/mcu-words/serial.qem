.equ UART_BASE , 0x10000000
.equ UART_LSR  , 5
.equ UART_RBR  , 0
.equ UART_TBR  , 0


# -----------------------------------------------------------------------------
  COLON  "usart1.init", USART1_INIT
# -----------------------------------------------------------------------------

  .word XT_EXIT 


# -----------------------------------------------------------------------------
  COLON  "serial.init", SERIAL_INIT
# -----------------------------------------------------------------------------

  .word XT_EXIT 



# -----------------------------------------------------------------------------
  CODEWORD  "serial-key", SERIAL_KEY
# -----------------------------------------------------------------------------
  savetos
  li t0, UART_BASE
  lb s3, UART_RBR(t0)
  NEXT
# -----------------------------------------------------------------------------
  CODEWORD  "serial-key?", SERIAL_KEYQ
# -----------------------------------------------------------------------------
  savetos
  li t0, UART_BASE
  lb t1, UART_LSR(t0)
  andi s3, t1, 1
  NEXT

# -----------------------------------------------------------------------------
  CODEWORD  "serial-emit", SERIAL_EMIT
# -----------------------------------------------------------------------------

1:

  li t0, UART_BASE
  lb t1, UART_LSR(t0)
  andi t1, t1, 0b100000
  beqz t1, 1b 


  sw s3, UART_TBR(t0)
  loadtos
  NEXT

# -----------------------------------------------------------------------------
  CODEWORD  "serial-emit?", SERIAL_EMITQ
# -----------------------------------------------------------------------------
  savetos
  
  li s3, -1 

  NEXT

COLON "serial-key-pause" , SERIAL_KEY_PAUSE
    .word XT_PAUSE,XT_SERIAL_KEYQ, XT_DOCONDBRANCH, PFA_SERIAL_KEY_PAUSE
    .word XT_SERIAL_KEY
    .word XT_EXIT

COLON "serial-emit-pause" , SERIAL_EMIT_PAUSE # ( c -- ) SERIAL: emit c on serial connection or pause if unable  
    .word XT_PAUSE,XT_SERIAL_EMITQ, XT_DOCONDBRANCH, PFA_SERIAL_EMIT_PAUSE
    .word XT_SERIAL_EMIT
    .word XT_EXIT
